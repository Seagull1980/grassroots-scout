import{j as e,b8 as O,B as c,y as he,T as i,ah as ge,ai as E,aj as D,G as j,C as I,a as b,I as xe,r as me,as as ye,at as pe,b$ as je,A as fe,v as ve,l as Ie,d as U,s as y,bS as be,H as Ce,z as we,ad as _,ag as $,a6 as H,a7 as G,a8 as J,a0 as Y,a9 as q,c7 as K,ac as Se,c4 as Te,f as Q}from"./mui-vendor-JAsu9f5S.js";import{e as Pe,r as l,a as Ae}from"./react-vendor-BTglNIF_.js";import{u as Me,A as C}from"./admin-features-R-myf6Sn.js";const V=o=>{const g=new Date().getTime()-o.getTime(),d=Math.floor(g/36e5),h=Math.floor(d/24);return d<1?"just now":d<24?`${d}h ago`:h<7?`${h}d ago`:o.toLocaleDateString()};function X(o){const{children:m,value:g,index:d,...h}=o;return e.jsx("div",{role:"tabpanel",hidden:g!==d,id:`messages-tabpanel-${d}`,"aria-labelledby":`messages-tab-${d}`,...h,children:g===d&&e.jsx(c,{sx:{p:3},children:m})})}const Ne=()=>{const{user:o}=Me(),m=Pe(),[g,d]=l.useState(0),[h,Z]=l.useState([]),[p,ee]=l.useState(null),[B,te]=l.useState([]),[N,ae]=l.useState([]),[se,ne]=l.useState(!0),[re,w]=l.useState(!1),[ie,S]=l.useState(!1),[T,F]=l.useState(""),[P,f]=l.useState(""),[n,A]=l.useState(null),[M,v]=l.useState(!1);l.useEffect(()=>{o&&(k(),oe())},[o]),l.useEffect(()=>{if(m.state&&m.state.recipientId){const t=m.state;A({id:t.recipientId,name:t.recipientName||"User",context:t.context,relatedVacancyId:t.relatedVacancyId,relatedPlayerAvailabilityId:t.relatedPlayerAvailabilityId,messageType:t.messageType}),f(t.context?`${t.context}

`:""),S(!0)}},[m.state]);const k=async()=>{try{const t=await fetch(`${C}/conversations`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const a=await t.json();Z(a.conversations||[])}}catch(t){console.error("Failed to load conversations:",t)}finally{ne(!1)}},oe=async()=>{try{const t=await fetch(`${C}/match-progress`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const a=await t.json();ae(a.matches||[])}}catch(t){console.error("Failed to load match progress:",t)}},R=async t=>{try{const a=await fetch(`${C}/conversations/${t}/messages`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(a.ok){const s=await a.json();te(s.messages||[])}}catch(a){console.error("Failed to load conversation messages:",a)}},L=t=>{ee(t),R(t.id)},le=async()=>{if(!(!p||!T.trim()))try{v(!0);const t=p.participants.find(s=>s.userId!==o?.id);if(!t){alert("Could not find recipient"),v(!1);return}const a=await fetch(`${C}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({recipientId:t.userId,subject:"Re: Conversation",message:T.trim(),messageType:"general"})});if(a.ok)F(""),w(!1),await R(p.id),await k();else{const s=await a.json().catch(()=>({error:"Unknown error"}));console.error("Failed to send reply:",s),alert(`Failed to send message: ${s.error||"Please try again"}`)}}catch(t){console.error("Failed to send message:",t),alert("Failed to send message. Please check your connection and try again.")}finally{v(!1)}},ce=async()=>{if(!(!n||!P.trim()))try{v(!0);const t=parseInt(n.id);console.log("Sending message to:",{recipientId:t,originalId:n.id,recipientName:n.name,relatedVacancyId:n.relatedVacancyId,relatedPlayerAvailabilityId:n.relatedPlayerAvailabilityId,messageType:n.messageType});const a={recipientId:t,subject:`Message regarding ${n.context||"availability"}`,message:P.trim(),messageType:n.messageType||"vacancy_interest"};if(n.relatedVacancyId){const r=String(n.relatedVacancyId),u=r.match(/\d+$/),x=parseInt(u?u[0]:r);isNaN(x)?console.warn("Invalid relatedVacancyId:",n.relatedVacancyId):(a.relatedVacancyId=x,console.log("Added relatedVacancyId:",a.relatedVacancyId,"from:",n.relatedVacancyId))}if(n.relatedPlayerAvailabilityId){const r=String(n.relatedPlayerAvailabilityId),u=r.match(/\d+$/),x=parseInt(u?u[0]:r);isNaN(x)?console.warn("Invalid relatedPlayerAvailabilityId:",n.relatedPlayerAvailabilityId):(a.relatedPlayerAvailabilityId=x,console.log("Added relatedPlayerAvailabilityId:",a.relatedPlayerAvailabilityId,"from:",n.relatedPlayerAvailabilityId))}const s=await fetch(`${C}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(a)});if(s.ok)f(""),A(null),S(!1),await new Promise(r=>setTimeout(r,500)),await k();else{let r;try{r=await s.json()}catch{r={error:"Unknown error occurred"}}console.error("Failed to send message:",{status:s.status,statusText:s.statusText,errorData:r,sentBody:a});let u="Failed to send message. ";if(s.status===401||s.status===403)u+="Your session has expired. Please log out and log back in to continue.";else if(s.status===404&&r.error?.includes("Recipient not found"))u+="The user you are trying to message could not be found. They may have deleted their account.";else if(s.status===400&&r.errors){const x=r.errors.map(ue=>ue.msg).join(", ");u+=x}else r.error?u+=r.error:u+=`Server error (${s.status}). Please try again.`;alert(u)}}catch(t){console.error("Failed to send new message:",t),alert("Failed to send message. Please check your internet connection and try again.")}finally{v(!1)}},z=t=>{switch(t){case"initial_interest":return"info";case"dialogue_active":return"primary";case"trial_invited":return"warning";case"trial_scheduled":return"warning";case"trial_completed":return"secondary";case"decision_pending":return"warning";case"match_confirmed":return"success";case"match_declined":return"error";case"completed":return"success";default:return"default"}},de=t=>{switch(t){case"initial_interest":return e.jsx(_,{});case"dialogue_active":return e.jsx(_,{});case"trial_invited":return e.jsx(Q,{});case"trial_scheduled":return e.jsx(Q,{});case"trial_completed":return e.jsx($,{});case"decision_pending":return e.jsx(Te,{});case"match_confirmed":return e.jsx($,{});case"match_declined":return e.jsx(Se,{});case"completed":return e.jsx($,{});default:return e.jsx(_,{})}},W=t=>{switch(t){case"initial_interest":return"Initial Interest";case"dialogue_active":return"In Discussion";case"trial_invited":return"Trial Invited";case"trial_scheduled":return"Trial Scheduled";case"trial_completed":return"Trial Completed";case"decision_pending":return"Awaiting Decision";case"match_confirmed":return"Match Confirmed";case"match_declined":return"Match Declined";case"completed":return"Completed";default:return"Unknown"}};return se?e.jsx(O,{maxWidth:"lg",children:e.jsx(c,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(he,{})})}):e.jsxs(O,{maxWidth:"xl",children:[e.jsxs(c,{sx:{mb:4},children:[e.jsx(i,{variant:"h3",component:"h1",gutterBottom:!0,children:"Messages & Match Progress"}),e.jsx(i,{variant:"h6",color:"text.secondary",children:"Centralised communication hub and match tracking"})]}),e.jsx(c,{sx:{borderBottom:1,borderColor:"divider",mb:3},children:e.jsxs(ge,{value:g,onChange:(t,a)=>d(a),children:[e.jsx(E,{label:e.jsx(D,{badgeContent:h.reduce((t,a)=>t+a.unreadCount,0),color:"error",children:"Conversations"})}),e.jsx(E,{label:e.jsx(D,{badgeContent:N.filter(t=>t.assignedTo===o?.role.toLowerCase()).length,color:"warning",children:"Match Progress"})})]})}),e.jsx(X,{value:g,index:0,children:e.jsxs(j,{container:!0,spacing:3,children:[e.jsx(j,{item:!0,xs:12,md:4,children:e.jsx(I,{children:e.jsxs(b,{children:[e.jsxs(c,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(i,{variant:"h6",children:"Conversations"}),e.jsx(xe,{onClick:k,size:"small",children:e.jsx(me,{})})]}),h.length===0?e.jsx(i,{color:"text.secondary",align:"center",py:4,children:"No conversations yet"}):e.jsx(ye,{children:h.map(t=>{const a=t.participants.find(s=>s.userId!==o?.id);return e.jsxs(pe,{button:!0,selected:p?.id===t.id,onClick:()=>L(t),children:[e.jsx(je,{children:e.jsx(D,{badgeContent:t.unreadCount,color:"error",children:e.jsx(fe,{children:e.jsx(ve,{})})})}),e.jsx(Ie,{primary:`${a?.firstName} ${a?.lastName}`,secondary:e.jsxs(Ae.Fragment,{children:[e.jsx(i,{variant:"body2",noWrap:!0,component:"span",display:"block",children:t.latestMessage.message}),e.jsxs("span",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"4px"},children:[e.jsx(U,{size:"small",label:W(t.matchProgressStage),color:z(t.matchProgressStage),variant:"outlined"}),e.jsx(i,{variant:"caption",color:"text.secondary",component:"span",children:V(new Date(t.latestMessage.createdAt))})]})]}),secondaryTypographyProps:{component:"div"}})]},t.id)})})]})})}),e.jsx(j,{item:!0,xs:12,md:8,children:p?e.jsx(I,{children:e.jsxs(b,{children:[e.jsxs(c,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(i,{variant:"h6",children:["Conversation with ",p.participants.find(t=>t.userId!==o?.id)?.firstName]}),e.jsx(y,{startIcon:e.jsx(be,{}),onClick:()=>w(!0),variant:"contained",children:"Reply"})]}),e.jsx(Ce,{sx:{mb:2}}),B.length===0?e.jsx(i,{color:"text.secondary",align:"center",py:4,children:"No messages in this conversation"}):e.jsx(c,{sx:{maxHeight:400,overflow:"auto"},children:B.map(t=>{const a=t.senderId===o?.id;return e.jsxs(we,{sx:{p:2,mb:2,ml:a?4:0,mr:a?0:4,bgcolor:a?"primary.light":"grey.100"},children:[e.jsx(i,{variant:"body1",gutterBottom:!0,children:t.message}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[a?"You":t.senderName," • ",V(new Date(t.createdAt))]})]},t.id)})})]})}):e.jsx(I,{children:e.jsx(b,{children:e.jsxs(c,{textAlign:"center",py:8,children:[e.jsx(_,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",children:"Select a conversation to view messages"})]})})})})]})}),e.jsx(X,{value:g,index:1,children:e.jsx(j,{container:!0,spacing:3,children:N.length===0?e.jsx(j,{item:!0,xs:12,children:e.jsx(I,{children:e.jsx(b,{children:e.jsxs(c,{textAlign:"center",py:8,children:[e.jsx($,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",color:"text.secondary",children:"No active matches in progress"})]})})})}):N.map((t,a)=>e.jsx(j,{item:!0,xs:12,md:6,children:e.jsx(I,{children:e.jsxs(b,{children:[e.jsxs(c,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2,children:[e.jsxs(c,{children:[e.jsx(i,{variant:"h6",children:o?.role==="Coach"?t.playerName:t.teamName}),e.jsxs(i,{color:"text.secondary",children:[t.position," • ",t.ageGroup]})]}),e.jsx(U,{icon:de(t.stage),label:W(t.stage),color:z(t.stage)})]}),e.jsxs(c,{mb:2,children:[e.jsxs(i,{variant:"body2",color:"text.secondary",children:["Last activity: ",V(new Date(t.lastActivity))]}),t.nextAction&&e.jsxs(i,{variant:"body2",fontWeight:"medium",mt:1,children:["Next: ",t.nextAction]}),t.trialDate&&e.jsxs(i,{variant:"body2",mt:1,children:["Trial scheduled: ",new Date(t.trialDate).toLocaleDateString()]})]}),e.jsxs(c,{display:"flex",gap:1,children:[e.jsx(y,{size:"small",onClick:()=>{const s=h.find(r=>r.id===t.conversationId);s&&(d(0),L(s))},children:"View Conversation"}),t.assignedTo===o?.role.toLowerCase()&&e.jsx(y,{size:"small",variant:"contained",children:"Take Action"})]})]})})},t.id||`match-${a}`))})}),e.jsxs(H,{open:re,onClose:()=>w(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(G,{children:"Send Reply"}),e.jsx(J,{children:e.jsx(Y,{fullWidth:!0,multiline:!0,rows:4,value:T,onChange:t=>F(t.target.value),placeholder:"Type your message...",sx:{mt:1}})}),e.jsxs(q,{children:[e.jsx(y,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(y,{onClick:le,variant:"contained",startIcon:e.jsx(K,{}),disabled:!T.trim()||M,children:M?"Sending...":"Send"})]})]}),e.jsxs(H,{open:ie,onClose:()=>{S(!1),A(null),f("")},maxWidth:"sm",fullWidth:!0,children:[e.jsxs(G,{children:["New Message ",n&&`to ${n.name}`]}),e.jsx(J,{children:e.jsx(Y,{fullWidth:!0,multiline:!0,rows:6,value:P,onChange:t=>f(t.target.value),placeholder:"Type your message...",sx:{mt:1}})}),e.jsxs(q,{children:[e.jsx(y,{onClick:()=>{S(!1),A(null),f("")},children:"Cancel"}),e.jsx(y,{onClick:ce,variant:"contained",startIcon:e.jsx(K,{}),disabled:!P.trim()||!n||M,children:M?"Sending...":"Send"})]})]})]})};export{Ne as default};
