import{j as e,ae as N,B as r,ak as K,T as a,l as Q,m as B,b6 as S,G as l,C as u,a as g,I as U,R as Y,x as q,y as X,cj as Z,A as ee,a6 as se,E as te,d as z,v as j,ck as ae,am as re,k as ne,bi as f,bf as y,J as ie,K as oe,N as ce,O as le,Q as de,cl as xe,az as he,cg as ue,f as L}from"./mui-vendor-rZ0WLTig.js";import{r as i}from"./react-vendor-CRXLTmIH.js";import{u as ge}from"./admin-features-d6LVy8Ft.js";import{a1 as w}from"./messaging-features-dHWz0ZXd.js";function R(n){const{children:d,value:x,index:o,...v}=n;return e.jsx("div",{role:"tabpanel",hidden:x!==o,id:`messages-tabpanel-${o}`,"aria-labelledby":`messages-tab-${o}`,...v,children:x===o&&e.jsx(r,{sx:{p:3},children:d})})}const ye=()=>{const{user:n}=ge(),[d,x]=i.useState(0),[o,v]=i.useState([]),[c,$]=i.useState(null),[I,W]=i.useState([]),[C,F]=i.useState([]),[O,E]=i.useState(!0),[G,m]=i.useState(!1),[p,_]=i.useState(""),[k,T]=i.useState(!1);i.useEffect(()=>{n&&(b(),V())},[n]);const b=async()=>{try{const s=await fetch("/api/conversations",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(s.ok){const t=await s.json();v(t.conversations||[])}}catch(s){console.error("Failed to load conversations:",s)}finally{E(!1)}},V=async()=>{try{const s=await fetch("/api/match-progress",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(s.ok){const t=await s.json();F(t.matches||[])}}catch(s){console.error("Failed to load match progress:",s)}},A=async s=>{try{const t=await fetch(`/api/conversations/${s}/messages`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const h=await t.json();W(h.messages||[])}}catch(t){console.error("Failed to load conversation messages:",t)}},D=s=>{$(s),A(s.id)},H=async()=>{if(!(!c||!p.trim()))try{T(!0),(await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({conversationId:c.id,message:p.trim(),messageType:"general"})})).ok&&(_(""),m(!1),A(c.id),b())}catch(s){console.error("Failed to send message:",s)}finally{T(!1)}},M=s=>{switch(s){case"initial_interest":return"info";case"dialogue_active":return"primary";case"trial_invited":return"warning";case"trial_scheduled":return"warning";case"trial_completed":return"secondary";case"decision_pending":return"warning";case"match_confirmed":return"success";case"match_declined":return"error";case"completed":return"success";default:return"default"}},J=s=>{switch(s){case"initial_interest":return e.jsx(f,{});case"dialogue_active":return e.jsx(f,{});case"trial_invited":return e.jsx(L,{});case"trial_scheduled":return e.jsx(L,{});case"trial_completed":return e.jsx(y,{});case"decision_pending":return e.jsx(ue,{});case"match_confirmed":return e.jsx(y,{});case"match_declined":return e.jsx(he,{});case"completed":return e.jsx(y,{});default:return e.jsx(f,{})}},P=s=>{switch(s){case"initial_interest":return"Initial Interest";case"dialogue_active":return"In Discussion";case"trial_invited":return"Trial Invited";case"trial_scheduled":return"Trial Scheduled";case"trial_completed":return"Trial Completed";case"decision_pending":return"Awaiting Decision";case"match_confirmed":return"Match Confirmed";case"match_declined":return"Match Declined";case"completed":return"Completed";default:return"Unknown"}};return O?e.jsx(N,{maxWidth:"lg",children:e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(K,{})})}):e.jsxs(N,{maxWidth:"xl",children:[e.jsxs(r,{sx:{mb:4},children:[e.jsx(a,{variant:"h3",component:"h1",gutterBottom:!0,children:"Messages & Match Progress"}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"Centralised communication hub and match tracking"})]}),e.jsx(r,{sx:{borderBottom:1,borderColor:"divider",mb:3},children:e.jsxs(Q,{value:d,onChange:(s,t)=>x(t),children:[e.jsx(B,{label:e.jsx(S,{badgeContent:o.reduce((s,t)=>s+t.unreadCount,0),color:"error",children:"Conversations"})}),e.jsx(B,{label:e.jsx(S,{badgeContent:C.filter(s=>s.assignedTo===n?.role.toLowerCase()).length,color:"warning",children:"Match Progress"})})]})}),e.jsx(R,{value:d,index:0,children:e.jsxs(l,{container:!0,spacing:3,children:[e.jsx(l,{item:!0,xs:12,md:4,children:e.jsx(u,{children:e.jsxs(g,{children:[e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(a,{variant:"h6",children:"Conversations"}),e.jsx(U,{onClick:b,size:"small",children:e.jsx(Y,{})})]}),o.length===0?e.jsx(a,{color:"text.secondary",align:"center",py:4,children:"No conversations yet"}):e.jsx(q,{children:o.map(s=>{const t=s.participants.find(h=>h.userId!==n?.id);return e.jsxs(X,{button:!0,selected:c?.id===s.id,onClick:()=>D(s),children:[e.jsx(Z,{children:e.jsx(S,{badgeContent:s.unreadCount,color:"error",children:e.jsx(ee,{children:e.jsx(se,{})})})}),e.jsx(te,{primary:`${t?.firstName} ${t?.lastName}`,secondary:e.jsxs(r,{children:[e.jsx(a,{variant:"body2",noWrap:!0,children:s.latestMessage.message}),e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"center",mt:.5,children:[e.jsx(z,{size:"small",label:P(s.matchProgressStage),color:M(s.matchProgressStage),variant:"outlined"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:w(new Date(s.latestMessage.createdAt),{addSuffix:!0})})]})]})})]},s.id)})})]})})}),e.jsx(l,{item:!0,xs:12,md:8,children:c?e.jsx(u,{children:e.jsxs(g,{children:[e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsxs(a,{variant:"h6",children:["Conversation with ",c.participants.find(s=>s.userId!==n?.id)?.firstName]}),e.jsx(j,{startIcon:e.jsx(ae,{}),onClick:()=>m(!0),variant:"contained",children:"Reply"})]}),e.jsx(re,{sx:{mb:2}}),I.length===0?e.jsx(a,{color:"text.secondary",align:"center",py:4,children:"No messages in this conversation"}):e.jsx(r,{sx:{maxHeight:400,overflow:"auto"},children:I.map(s=>{const t=s.senderId===n?.id;return e.jsxs(ne,{sx:{p:2,mb:2,ml:t?4:0,mr:t?0:4,bgcolor:t?"primary.light":"grey.100"},children:[e.jsx(a,{variant:"body1",gutterBottom:!0,children:s.message}),e.jsxs(a,{variant:"caption",color:"text.secondary",children:[t?"You":s.senderName," • ",w(new Date(s.createdAt),{addSuffix:!0})]})]},s.id)})})]})}):e.jsx(u,{children:e.jsx(g,{children:e.jsxs(r,{textAlign:"center",py:8,children:[e.jsx(f,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"Select a conversation to view messages"})]})})})})]})}),e.jsx(R,{value:d,index:1,children:e.jsx(l,{container:!0,spacing:3,children:C.length===0?e.jsx(l,{item:!0,xs:12,children:e.jsx(u,{children:e.jsx(g,{children:e.jsxs(r,{textAlign:"center",py:8,children:[e.jsx(y,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(a,{variant:"h6",color:"text.secondary",children:"No active matches in progress"})]})})})}):C.map(s=>e.jsx(l,{item:!0,xs:12,md:6,children:e.jsx(u,{children:e.jsxs(g,{children:[e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:2,children:[e.jsxs(r,{children:[e.jsx(a,{variant:"h6",children:n?.role==="Coach"?s.playerName:s.teamName}),e.jsxs(a,{color:"text.secondary",children:[s.position," • ",s.ageGroup]})]}),e.jsx(z,{icon:J(s.stage),label:P(s.stage),color:M(s.stage)})]}),e.jsxs(r,{mb:2,children:[e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Last activity: ",w(new Date(s.lastActivity),{addSuffix:!0})]}),s.nextAction&&e.jsxs(a,{variant:"body2",fontWeight:"medium",mt:1,children:["Next: ",s.nextAction]}),s.trialDate&&e.jsxs(a,{variant:"body2",mt:1,children:["Trial scheduled: ",new Date(s.trialDate).toLocaleDateString()]})]}),e.jsxs(r,{display:"flex",gap:1,children:[e.jsx(j,{size:"small",onClick:()=>{const t=o.find(h=>h.id===s.conversationId);t&&(x(0),D(t))},children:"View Conversation"}),s.assignedTo===n?.role.toLowerCase()&&e.jsx(j,{size:"small",variant:"contained",children:"Take Action"})]})]})})},s.id))})}),e.jsxs(ie,{open:G,onClose:()=>m(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(oe,{children:"Send Reply"}),e.jsx(ce,{children:e.jsx(le,{fullWidth:!0,multiline:!0,rows:4,value:p,onChange:s=>_(s.target.value),placeholder:"Type your message...",sx:{mt:1}})}),e.jsxs(de,{children:[e.jsx(j,{onClick:()=>m(!1),children:"Cancel"}),e.jsx(j,{onClick:H,variant:"contained",startIcon:e.jsx(xe,{}),disabled:!p.trim()||k,children:k?"Sending...":"Send"})]})]})]})};export{ye as default};
